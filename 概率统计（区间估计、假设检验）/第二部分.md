##第五章 方差分析

###5.1 方差分析的基本原理

效应与误差模型

对于任意的随机变量X，它都可以分解成两部分
$$
X = \mu + \epsilon
$$
称X的均值$\mu$ 为X的效应，效应是固定的也称为固定效应，$\epsilon$ 为X关于$\mu$ 的误差。
$$
X \sim N(\mu, \sigma^2) 等价于 \epsilon \sim N(0, \sigma^2)
$$
样本的数据分解与平方和分解

对于X的随机样本$X_1, X_2,...,X_n$ ，其每一个观察值
$$
X_i = \mu + \epsilon_i，i=1,2,...,n 且E(\epsilon_i) = 0，Var(\epsilon_i)=Var(X_i)=\sigma^2
$$
用样本均值估计总体均值的数据分解
$$
X_i = \overline{X} + (X_i - \overline{X})，i=1,2,...,n，其中X_i - \overline{X}是误差\epsilon_i的估计
$$
平方和分解（正交分解$a^2+2ab+b^2 = a^2 + b^2 ,2ab=0$）
$$
\sum_{i=1}^{n} X_i^2 = n\overline{X}^2 + \sum_{i=1}^{n}(X_i - \overline{X})^2
$$


自由度分解
$$
n = 1 + (n-1)
$$
实际意义：数据分解可以写成向量形式
$$
\left (\begin{matrix}
X_1 \\
X_2 \\
...     \\
X_n
\end{matrix} \right ) =
\left (\begin{matrix}
\overline{X} \\
\overline{X}\\
...     \\
\overline{X}
\end{matrix} \right ) +
\left (\begin{matrix}
X_1 - \overline{X}\\
X_2 - \overline{X}\\
...     \\
X_n -\overline{X}
\end{matrix} \right ) ，其中分解后两个向量正交
$$
平方和分解满足向量的勾股定理或力学分解即作用于样本数据的力可以独立地分解为总体效应的估计和误差的估计这两种力。则有勾股定理可以得到
$$
\left (\begin{matrix}
X_1 \\
X_2 \\
...     \\
X_n
\end{matrix} \right )^2 =
\left (\begin{matrix}
\overline{X} \\
\overline{X}\\
...     \\
\overline{X}
\end{matrix} \right )^2 +
\left (\begin{matrix}
X_1 - \overline{X}\\
X_2 - \overline{X}\\
...     \\
X_n -\overline{X}
\end{matrix} \right )^2
$$
假设检验（正态总体条件下）：$H_0: \mu=0；H_1: \mu \ne 0$

T检验统计量
$$
T_0 = \frac{\overline{X}}{S / \sqrt{n}} \sim t(n-1) ，H_0为真时
$$
T检验统计量的等价检验为自由度为(1, n-1)的F检验
$$
F = T_0^2 = \frac{\overline{X}^2}{S^2 / n} = \frac{n \overline{X}^2 / 1}{\sum_{i=1}^{n}(X_i-\overline{X})^2 / (n-1)} \sim F(1, n-1) ，H_0为真时
$$
F检验与数据平方和分解的关系
$$
平方和分解：SS  = SS_{\mu} + SS_{\epsilon} ，其中SS=\sum_{i=1}^{n}X_i^2，SS_{\mu} = n \overline{X}^2 \\
SS_{\epsilon}  = \sum_{i=1}^{n}(X_i - \overline{X})^2 \\
自由度分解：f = f_{\mu} + f_{\epsilon}，其中f = n，f_{\mu} = 1，f_{\epsilon} = n-1
$$
F检验统计量可以写成
$$
F = \frac{SS_{\mu} / f_{\mu}}{SS_{\epsilon} / f_{\epsilon}} \sim F(f_{\mu}, f_{\epsilon})，H_0为真时
$$

###5.2 单因素方差分析

| 因素水平 | r个独立样本                 | 样本总和 | 水平均值         | 总体均值       |
| -------- | --------------------------- | -------- | ---------------- | -------------- |
| $A_1$    | $X_{11},X_{12},...X_{1n_1}$ | $T_1$    | $\overline{X_1}$ | $\overline{X}$ |
| $A_2$    | $X_{21},X_{22},...X_{2n_2}$ | $T_2$    | $\overline{X_2}$ | $\overline{X}$ |
| ...      | ...                         | ...      | ...              | ...            |
| $A_r$    | $X_{r1},X_{r2},...X_{rn_r}$ | $T_r$    | $\overline{X_r}$ | $\overline{X}$ |

其中
$$
\overline{X}_i = \frac{1}{n_i} \sum_{j=1}^{n_i} X_{ij} \\
\overline{X} = \frac{1}{n}\sum_{i=1}^{r}n_i \overline{X}_i，其中n=\sum_{i=1}^{r}n_i \\
$$
上表数据结构是按一种方式或一个因素进行分组，例如：一个力分解为r个力，而r个力中每一个力实施的大小水平是不同的。数据模型为
$$
X_{ij} = \mu_i + \epsilon_{ij}，其中i=1,2,...,r，j=1,2,...,n_i 
$$
假定
$$
X_{ij} \sim N(\mu_i, \sigma^2)或\epsilon_{ij} \sim N(0, \sigma^2) \\
X_{11},...,X_{1n_1};...;X_{r1},...,X_{rn_r} 相互独立、方差相同
$$
假设检验：$H_0: \mu_1=...=\mu_r；H_1: \mu_1,...,\mu_r 不全相等 $

因素效应模型
$$
因素水平的总平均 \mu = \frac{1}{n}\sum_{i=1}^{r}n_i \mu_i，其中n=\sum_{i=1}^{r}n_i \\
因素水平A_i的效应 \alpha_i = \mu_i - \mu 满足\sum_{i=1}^{r}n_i \alpha_i = 0
$$
单因素方差分析模型的另一种表示
$$
X_{ij} = \mu + \alpha_i + \epsilon_{ij}，其中j=1,...,n_i，i=1,2,...,r \\
\sum_{i=1}^{r}n_i \alpha_i = 0，\epsilon_{ij} \sim N(0, \sigma^2)且相互独立
$$
假设检验的另一种表示
$$
H_0: \alpha_1=...=\alpha_r；H_1: \alpha_1,...,\alpha_r 不全为零
$$


**离差平方和**

总离差平方和(Sum of Squares for Total, SST)映全部观察值的离散状况，计算公式为
$$
SST = \sum_{i=1}^{r} \sum_{j=1}^{n_i} (x_{ij} - \overline{X})^2
$$
组间离差平方和(Sum of Squares for Factor A，SSA)又称水平项离差平方和，包括随机误差和系统误差，计算公式为
$$
SSA = \sum_{i=1}^{r} n_i (\overline{X}_i - \overline{X})^2
$$
组内离差平方和(Sum of Squares for Error，SSE)又称误差项离差平方和，反映了`水平` 内部观察值的离散情况，即随机因素的影响。计算公式为
$$
SSE = \sum_{i=1}^{r}\sum_{j=1}^{n_i} (x_{ij} - \overline{X}_i)^2
$$
**方差分析表**

| 方差来源 | 离差平方和 | df（自由度） | 均方MS        | F       |
| -------- | ---------- | ------------ | ------------- | ------- |
| 组间     | SSA        | r-1          | MSA=SSA/(r-1) | MSA/MSE |
| 组内     | SSE        | n-r          | MSE=SSE/(n-r) |         |
| 总方差   | SST        | n-1          |               |         |

**判断结果**

1. 若$F \ge F_{\alpha}(f_{\mu}, f_{\epsilon}) 或P值 \ge \alpha$ 则拒绝原假设，表明均值之间差异显著，因素A对观察值有显著影响；
2. 若$F \lt F_{\alpha}(f_{\mu}, f_{\epsilon}) 或P值 \lt \alpha$ 则不能拒绝原假设，表明均值之间差异不显著，因素A对观察值没有显著影响。

例子：某人在街头随机访问9人，请他们对某事件打分，然后按他们的职业A,B,C进行分组，得

| 职业 | 打分    | 样本总和 | 样本均值 | 样本量 |
| ---- | ------- | -------- | -------- | ------ |
| A    | 3,7     | 10       | 5        | 2      |
| B    | 4,2,7,3 | 16       | 4        | 4      |
| C    | 8,4,6   | 18       | 6        | 3      |

请问各职业人群之间的评价是否有显著差异？

![均值单因素方差分析例子1](img/均值单因素方差分析例子1.png)

Excel中显著水平默认为0.05，因为
$$
F=0.688889 < F_{\alpha=0.05}(2,6) = 5.143253，P值=0.53787\\
则不拒绝原假设 H_0：\mu_a=\mu_b=\mu_c
$$
则各职业人群之间不存在显著差异。

###5.3 无相互作用的双元素方差分析 

无交互作用的双元素模型为
$$
X_{ij} = \mu + \alpha_i + \beta_j + \epsilon_{ij}，其中\sum_{i=1}^{r} \alpha_i=0，\sum_{j=1}^{s} \beta_j=0 \\
\alpha_i = \mu_{i*} - \mu，\beta_j = \mu_{*j} - \mu \\
\mu = \frac{1}{rs}\sum_{i=1}^{r} \sum_{j=1}^{s} x_{ij} \\
\mu_{i*} = \frac{1}{s} \sum_{j=1}^{s} x_{ij} \\
\mu_{i*} = \frac{1}{r} \sum_{j=1}^{r} x_{ij} \\
$$
**离差平方和** 
$$
SST = \sum_{i=1}^{r} \sum_{j=1}^{s}(X_{ij} - \overline{X})^2 \\
SSA = \sum_{i=1}^{r}(\overline{X_{i*}} - \overline{X})^2\\
SSB = \sum_{j=1}^{s}(\overline{X_{*j}} - \overline{X})^2\\
SSE =  \sum_{i=1}^{r} \sum_{j=1}^{s}(X_{ij} - \overline{X}_{i or j})^2 \\ 
\ \\
满足方程 SST = SSA + SSB + SSE
$$
**方差分析表** 
| 方差来源 | 离差平方和 | df         | 均方MS               | F       |
| -------- | ---------- | ---------- | -------------------- | ------- |
| 因素A    | SSA        | r-1        | MSA=SSA/(r-1)        | MSA/MSE |
| 因素B    | SSB        | s-1        | MSB=SSB/(s-1)        | MSB/MSE |
| 误差     | SSE        | (r-1)(s-1) | MSE = SSE/(r-1)(s-1) |         |
| 总方差   | SST        | rs-1       |                      |         |

**原假设** 
$$
对因素A \quad H_0：\mu_1=\mu_2=...\mu_r=0；H_1： \mu_1,...,\mu_r不全相等 \\
对因素B \quad H_0：\mu_1=\mu_2=...=\mu_s=0；H_1： \mu_1,...,\mu_s不全相等
$$


**判别条件** 

1. 若$F_A \ge F_{\alpha}(r-1, (r-1)(s-1))$ ，则拒绝原假设$H_{01}$ ，表明因素A对观察值有显著影响；
2. 若$F_B \ge F_{\alpha}(s-1,(r-1)(s-1))$ ，则拒绝原假设$H_{02}$ ，表明因素B对观察值有显著影响；



###5.4有交互作用的双元素方差分析

| 因素水平 | $B_1$            | ...  | $B_s$            | 均值             |
| -------- | ---------------- | ---- | ---------------- | ---------------- |
| $A_1$    | $X_{11}$         | ...  | $X_{1s}$         | $\overline{X}_1$ |
| ...      | ...              | ...  | ...              | ...              |
| $A_r$    | $X_{r1}$         | ...  | $X_{rs}$         | $\overline{X}_r$ |
| 均值     | $\overline{X}_1$ | ...  | $\overline{X}_s$ | $\overline{X}$   |

1. 建立假设
   $$
   对因素A \quad H_{01}：\alpha_i =0；H_{11}：H_{11}：a_i不全为零 \\
   对因素B \quad H_{02}：\beta_j = 0；H_{12}：\beta_i不全为零 \qquad \ \ \\
   对因素A和B的交互效应 \quad H_{03}：(\alpha \beta)_{ij} = 0 ；H_{13}：(\alpha \beta)_{ij}不全为零
   $$

2. 构造检验F统计量，假设X为t维向量
   $$
   SST = \sum_{i=1}^{r} \sum_{j=1}^{s} \sum_{k=1}^{t}(X_{ij}(t) - \overline{X})^2 \\
   SSA = \sum_{i=1}^{r}st(X_{i*} - \overline{X}_i)^2 \\
   SSB =  \sum_{j=1}^{s}rt(X_{*j} - \overline{X}_j)^2 \\
   SSAB =\sum_{i=1}^{r} \sum_{j=1}^{s} t(\overline{X} - \overline{X}_{i*} - \overline{X}_{*j} + \overline{X_{ijt}})\\
   SSE = \sum_{i=1}^{r} \sum_{j=1}^{s} \sum_{k=1}^{t} (X_{ij}(k) - \overline{X_{i or j}})^2
   $$
   有交互作用的双因素方差分析表

   | 方差来源  | 离差平方和 | df         | 均方MS                 | F        |
   | --------- | ---------- | ---------- | ---------------------- | -------- |
   | 因素A     | SSA        | r-1        | MSA=SSA/(r-1)          | MSA/MSE  |
   | 因素B     | SSB        | s-1        | MSB=SSB/(s-1)          | MSB/MSE  |
   | 因素A * B | SSAB       | (r-1)(s-1) | MSAB=SSAB/[(r-1)(s-1)] | MSAB/MSE |
   | 误差      | SSE        | rs(t-1)    | MSE = SSE/rs(t-1)      |          |
   | 总方差    | SST        | n-1        |                        |          |

   **判别条件**

   1. 若$F_A \ge F_{\alpha}(r-1, n - rs)$ ，则拒绝原假设$H_{01}$ ，表明因素A对观察值有显著影响；
   2. 若$F_B \ge F_{\alpha}(s-1, n - rs)$ ，则拒绝原假设$H_{02}$ ，表明因素B对观察值有显著影响；
   3. 若$F_{AB} \ge F_{\alpha}(n-r-s+1, n - rs)$ ，则拒绝原假设$H_{03}$ ，表明因素A、B的交互效应对观察值有显著影响；

例子：电池的板极材料与使用的环境温度对电池的输出电压均有影响，令材料类型与环境温度都取了三个水平，测得输出电压数据如下所示，问不同材料、不同温度及它们交互作用对输出电压有无显著影响？

| 材料类型 | 15摄氏度                                            | 25摄氏度                                            | 35摄氏度                                         |
| -------- | --------------------------------------------------- | --------------------------------------------------- | ------------------------------------------------ |
| 1        | $\begin{matrix} 130 & 155 \\ 174 & 180\end{matrix}$ | $\begin{matrix} 34& 40 \\ 80 & 75\end{matrix}$      | $\begin{matrix} 20 & 70 \\ 82 & 58\end{matrix}$  |
| 2        | $\begin{matrix} 150 & 188 \\ 159 & 126\end{matrix}$ | $\begin{matrix} 136 & 122 \\ 106 & 115\end{matrix}$ | $\begin{matrix} 25 & 70 \\ 58 & 45\end{matrix}$  |
| 3        | $\begin{matrix} 138 & 110 \\ 168 & 160\end{matrix}$ | $\begin{matrix} 174 & 120 \\ 150 & 139\end{matrix}$ | $\begin{matrix} 96 & 104 \\ 82 & 60\end{matrix}$ |

![可重复双因素分析1](img/可重复双因素分析1.png)

![可重复双因素分析2](img/可重复双因素分析2.png)

![可重复双因素分析3](img/可重复双因素分析3.png)

使用Excel中数据分析工具"可重复双因素分析"就能够得到以上结果，P值可以判断，上述原假设均被拒绝，因此材料、温度与温度和材料的交互都会对观测值的结果产生影响。



##第六章 相关与回归分析

