#时间序列分析基础

什么是时间序列？

时间序列的研究内容和方法？ ----按照模型公式用于预测？预测的结果（定量）都是有条件的，在一定范围内是有效的。

时间序列分析应用？质量控制，经济预测，异常检测，气象预报，探测矿产等，用定量的方法控制质量。最有价值的应用就是别人没做过，自己是首创。

什么是科学？科学就是解释现象？解释的未必是真理，你解释（假设）的未必正确，需要不断通过实践检验、修正你的解释。

##第一章 差分方程

**时间序列模型一般原理**：时间序列通常可以分解为``趋势性``、``季节性``、``循环或周期性``和``无规律性``（干扰项）这四项。前三项具有可预测性，第四项对前三项有干扰性。如果干扰或波动大小可以被估计，那么时间序列的预测是可以进行的。例如：菜的价格会有波动，不同地方价格不动，但是差别不会超过1元，那么这个价格就是可以预测的。

假设条件不变或条件是已知的，种黄瓜的人数确定，那么可以预测明年的收成，假设结果误差不超过10%。若不考虑波动是可以精确预测的。例子：

- 趋势项方程：$T_t = 1 + 0.1t$  ，$T_t$ 为t期的趋势性成分
- 周期性方程：$S_t = 16sin(\frac{t \pi }{6})$ ，$S_t$ 为t期周期性成分 
- 无规律性方程：$I_t = 0.7I_{t-1} +\epsilon_t$ ，第一项前后自相关，$I_t$ 

**差分方程**：是将变量表示为该变量滞后值、时间和其他变量的函数，可以表示为$\triangledown y_t = f(y_{t-1, \ t, \ x_t, \ \epsilon_t, ....})$ ，按照定义，前面三个成分方程都是差分方程。差分方程定义依赖两条：

1. 差分的定义，$\triangledown y_t = y_t - y_{t-1} $ 就是差分方程，数学定义为$\triangledown y_t = f(t_{t-1}, x, t)$ 在添加一个波动项$\epsilon_t$ 就可；
2. 满足方程的定义；

例子：随机游走（随机漫步） 
$$
y_{t+1} = y_t + \epsilon_{t+1} \quad \rightarrow \quad \triangle y_{t+1} = \epsilon_{t+1} \\
推广随机游走模型：添加一个常数项和线性项 \\
 \triangle  y_{t+1} = a_0 + bx + \epsilon_{t+1} \tag{1}
$$
###1.1 结构方程和诱导方程 

将差分方程拆分成独立的单方程模型是很有用的，例如：随机形式的萨缪尔森经典模型
$$
y_t = c_t + i_t \\
c_t = a y_{t-1} + \epsilon_{ct},  \quad 0 \lt a \lt 1 \\
i_t = \beta(c_t - c_{t-1}) + \epsilon_{it}， \quad \beta \gt 0 \tag{2}
$$
其中$y_t, c_t, i_t$ 分别表示t期的实际GDP，消费和投资。$\epsilon_{ct}， \epsilon_{it}$ 分别是消费和投资的随机干扰项，均值为0，$\alpha，\beta$ 是待估参数。第三个方程表示加速原理，即在消费增长必定带来新的投资支出前提下，投资支出等于消费变动的一定倍数。这是一个`结构方程` ，因为它表明两个当期内变量$i_t和c_t$ 之间满足某个约束条件或系统结构。

`诱导方程`（可以被推导出来的方程）是将当期变量表示为该变量滞后值、其他内生变量的滞后值（系统内部变量）、外生变量的当期值（外部变量）和外生变量的过去值、以及扰动项的函数。诱导方程并不唯一。
$$
c_t = a y_{t-1} + \epsilon_{ct},  \quad 0 \lt a \lt 1  \\
i_t = \beta(c_t - c_{t-1}) + \epsilon_{it}， \quad \beta \gt 0 \\
\downarrow  一式带入二式\\
i_t = \beta(ay_{t-1} + \epsilon_{ct} - ay_{t-2} + \epsilon_{c(t-1)}) + \epsilon_{it} \quad (诱导方程) \tag{3}
$$
###1.2 差分方程

差分方程：$\triangle y_{t+h} = f(t+h) - f(t) = y_{t+h} - y_{t}$ ，当h=1时为一阶差分。

一阶差分
$$
\triangle y_t = f(t) - f(t-1) = y_t - y_{t-1} \\
\triangle y_{t + 1} =  f(t+1) - f(t) = y_{t+1}- y_{t} \tag{4}\\
$$
可以从一阶差分得到二阶差分
$$
\triangle^2 y_t = \triangle (\triangle y) = \triangle ( y_t - y_{t-1})  = (y_t - y_{t-1}) - (y_{t-1} - t_{t - 2}) \\
= y_t - 2y_{t-1} + y_{t-2} \tag{5}
$$
n阶差分为$(\triangle ^n)$

**差分方程形式** 

考虑n阶常系数线性差分方程， 其一般形式可以写为
$$
y_t = a_0 + \sum_{i=1}^{n}a_iy_{t-i} + x_i \tag{6}
$$
其中$x_i$ 为**推动过程** ，可以是时间、其他变量的当期值或滞后值、随机干扰项的任意函数。$\{x_t\}$ 的一个重要特例是
$$
x_t = \sum_{i=1}^{\propto} \beta_i \epsilon_{t-i} \tag{7}
$$
其中$\beta_i$ 为常数，序列$epsilon_{t}$ 不是$y_t$ 的函数，于是认为$\{ \epsilon_t\}$ 只不过是一个为取定外生变量的序列。令$\beta = 1, \beta_1=\beta_2=...=0$ ，得到自回归方程
$$
y_t = a_0 + a_1 y_{t-1} + a_2 y_{t-2} + ... + a_m y_{t-n} + \epsilon_t \quad 自回归方法 \tag{8}
$$
###1.3 差分方程的解

差分方程的解是将未知项$y_t$ 表示为序列$\{ x_t \}$ 中的元素和t（也和序列$\{ y_t\}$ 的一些给定值即初始条件）的一个已知函数，使得代入到差分方程之后，满足方程式。

例子1：$\triangle y_t = 2 或者y_t = y_{t-1} + 2$ , 可以知道$y_t = 2t+c$  为该方程的解（采用迭代法求解）。

例子2：考虑无规律性方程$I_t = 0.7I_{t-1} + \epsilon_{t}$ 的解，该一阶差分方程的解为$I_t = \sum_{i=1}^{\propto} \epsilon_{t-i}$

####1.3.1 迭代法

迭代法分为向前迭代和向后迭代。通过对y的诱导方程进行迭代，有可能得到整个y序列的解。更具初始条件不同，可以采用不同的迭代方法。

1. 初始条件已知的迭代

   考虑初始条件y0已知的一阶差分方程$y_t = a_0 + a_1y_{t-1} + \epsilon_t$ ,

   `向前迭代`
   $$
   y_1=a_0 + a_1y_0 + \epsilon_t \\
   y_2 = a_0 + a_1y_1+\epsilon_2=a_0+a_1(a_0+a_1y_0+\epsilon_1) +\epsilon_2\\
   =a_0+a_0a_1+a_1^2y_0+a_1\epsilon_1 + \epsilon_2 \\
   y_3=a_0+a_1y_2+\epsilon_3 = ... =(a_0 + a_0a_1+a_0a_1^2) + \\
   a_1^3y_0 + (a_1^2\epsilon_1 + a_1\epsilon_2+\epsilon_3) \\
   \ \\
   y_t = a_0 \sum_{i=0}^{t-1}a_1^i + a_1^ty_0 + \sum_{i=0}^{t-1}a_1^i\epsilon_{t-i}（几何级数求和）\tag{9}
   $$
   类似可以用后向迭代求得$y_t$ 的通解

2. 初始条件未知的迭代（无限向后迭代）

   初始条件y0未知时，上式求得解释未知的，即不是一阶差分方差的解，因此需要对其继续向后迭代，得到
   $$
   y_t = a_0 \sum_{i=0}^{t-1}a_1^i + a_1^ty_0 + \sum_{i=0}^{t-1}a_1^i\epsilon_{t-i} \\
   =a_0 \sum_{i=0}^{t-1}a_1^i + a_1^t(a_0+a_1y_{-1} + \epsilon_0) +  \sum_{i=0}^{t-1}a_1^i\epsilon_{t-i}  \\
   =a_0 \sum_{i=0}^{t}a_1^i + a_1^{t+1}y_{-1} + \sum_{i=0}^{t}a_1^i\epsilon_{t-i} \\
   ... \\
   =a_0 \sum_{i=0}^{t+m-1}a_1^i + a_1^{t+m}y_{-m} + \sum_{i=0}^{t+m-1}a_1^i\epsilon_{t-i} \tag{10}
   $$
   上述方程式一个级数的展开、，若$|a_1| \lt 1$ ，则当$m \rightarrow \propto$ 时。得到一阶差分方程的一个解为
   $$
   y_t = \frac{a_0}{1-a_1} + \sum_{i=0}^{\propto}a_1^i \epsilon_{t-i} \tag{11}
   $$
   
   容易验证，对于任何常数A， 
   $$
   y_t =Aa_1^t+ \frac{a_0}{1-a_1} + \sum_{i=0}^{\propto}a_1^i \epsilon_{t-i} \tag{12}
   $$
   也是一阶差分方程的解

3. 两种迭代法的混合解

   由于上述解带有一个任意常数A，所以他可以用来确定初始条件已知的差分方程的解，令t=0，则得到A的值为
   $$
   A=y_0 - \frac{a_0}{1-a_1} - \sum_{i=0}^{\propto}a_1^i\epsilon_{-i} \tag{13}
   $$
   将A带入原式中就得到初始条件已知时的一阶差分方程的一个解
   $$
   y_t=\frac{a_0}{1-a_1} + [y_0 - \frac{a_0}{1-a_1}]a_1^t + \sum{i=0}{t-1}a_1i\epsilon{t-i} \tag{14}
   $$
   这个解与1中的是等价的

**非收敛序列（收敛性）**

- 当$|a_1| \lt 1$ ,则(10)收敛到(11)
- 当$|a_1|  \gt 1$ ,则(10)不收敛或发散，但只要给出初始条件y0，则可使用(10)或(12)中的解
- 当$|a_1| =1 $ ，一阶差分方程可以写为$y_t=a_0+y_{t-1} + \epsilon_t$ 使用迭代法可以得到$y_t=a_0t + \sum_{i=1}^{t}\epsilon_i + y_0$ 。当初始条件y0给定时，后者是前者的解；若没有初始条件，则后者可以使不收敛或发散的，y0又未知所以不是前者差分方程的解。

PS：针对时间序列分析，若预测方程的系数$|a_1| \lt 1$ 则方程的解是稳定的，收敛的，就可以预测；否则就无法预测。解的稳定性取决于系数是大于1还是小于1。

`推广` ：对于二次差分方程，如何求解，如何判断解是否稳定？如此推广到其他高阶差分方程。

####1.3.2 备选解法

对于一般的差分方程$y_t=a_0 +\sum_{i=1}^{n}a_ty_{t-i} +x_t$ ，当阶数n较高时，迭代法就不适用的，为此可以使用其他备选解法。

1. 齐次方程

   差分方程中常数项a0和推动过程项$x_t$ 都不出现时，就得到齐次差分方程为
   $$
   y_t=\sum_{i=1}^{n}a_iy_{t-i}  \tag{15}
   $$
   齐次方程解的一个性质是：若$y_t^h$ （h是一个记号，表示为方程的一个解）是齐次方程的一个解，则对于任意常数A，$A y_t^h$ 也是齐次方程的一个解。

2. 一阶差分方程的备选解法

   考虑一阶差分方程$y_t=a_0+a_1y_{t-1}+x_t$ ，则得到一阶齐次方程$y_t=a_1y_{t-1}$ ，显然恒零序列$y_t=y_{t-1}=....=0$ 是齐次方程的一个解，另外当初始条件y非零且已知时，$y_t^h=a_1^i y_0$ 也是它的一个解。两者都包含在一阶齐次方程的通解$y_t=Ay_t^{h}$ 中A为任意常数。若$y_t^p$ 是一阶差分方程的一个特解，则该差分方程的通解为
   $$
   y_t = y_t^p + Ay_t^h = y_t^p + Aa_1^ty_0 ，其中A=1-\frac{y_0^p}{y_0} \tag{16}
   $$

3. 一般差分方程的解法

   对于一般差分方程，其求解方法通常为

   - 建立齐次方程，求出它的n个齐次解，$y_t^{h_1},y_t^{h_2},...,y_t^{h_n}$
   - 求出差分方程的一个特解$y_t^p$ 
   - 通解为所有齐次解的线性组合与特解之和，$y_t=y_t^p + \sum_{i=1}^{n}A_i y_i^{h_i}$ 
   - 将初始条件带入通解中，确定线性组合的系数$A_1,A_2,...,A_n$


###1.4 解齐次差分方程 

对于一般n(线性)解差分方程
$$
y_t=a_0 +\sum_{i=1}^{n}a_ty_{t-i} +x_t \tag{17}
$$

1. 解一阶齐次差分方程

   一阶齐次差分方程$y_t=a_1y_{t-1} $的解形式为$y_t=Aa_1^t$，其中A为任意常数

2. 解二阶齐次差分方程

   一般二阶齐次方程$y_t - a_1y_{t-1}-a_2y_{t-2}=0 $ ，猜想其齐次解如一阶一样具有相同形式$y^h_t=Aa^t$，其中a待定，A为任意常数，带入二阶齐次差分方程得：
   $$
   Aa^t -a_1Aa^{t-1} - a_2Aa^{t-2} = 0 \tag{18}
   $$
   消去A和$a^{t-2}$之后得 ，得到关于a的一元二次方程
   $$
   a^2-a_1a-a_2 = 0 \tag{19}
   $$
   称为`特征方程`，对应方程的解称为`特征解` 。根据一元二次方程求特征根为
   $$
   a_1,a_2=\frac{a_1 \pm \sqrt{a_1^2+4a_2}}{2}=\frac{a_1 \pm \sqrt{d}}{2} \tag{20}
   $$
   其中 $d=a_1^2+4a_2$为判别式，于是$A_1(a_1)^t，A_2(a_2)^t$都是二阶差分方程的解，其中$A_1，A_2$为任意常数其它之和
   $$
   y_t^h = A_1(a_1)^t + A_2(a_2)^t \tag{21}
   $$
    为二阶差分方程的齐次解，但是接的性质取决于特征根$a_1,a_2$和判别式d。

   ​

**情况1：判别式 $a_1^2+4a_2 \gt 0$** 

此时，a1和a2为两个不同的实数特征根，当a1或a2的绝对值大于1时，则二阶差分方程的齐次解就趋于发散。

例子1：$y_t = 0.2y_{t-1} + 0.35y_{t-2}$
$$
a_1,a_2 = \frac{a_1 \pm \sqrt{a_1^2+4a_2}}{2} = \frac{0.2 \pm \sqrt{0.2^2 + 4 * 0.35}}{2} \\
=\frac{0.2 \pm \sqrt{1.44}}{2} = 0.7，-0.5
$$
则齐次解为
$$
y_t^h = A_1(0.7)^t + A_2(-0.5)^t
$$
查看其解的轨迹可以知道，随着时间 t的增大，解趋近于零。

![二次差分方程解收敛](imgs/二次差分方程解收敛.png)

例子2：$y_t=  0.7y_{t-1} + 0.35y_{t-2}$

同样可以求得$a_1，a_2 = 1.037，-0.337$ ,则其次解为
$$
y_t^h = A_1(1.037)^t + A_2(-0.337)^t
$$
查看此解的轨迹可以看出随时间t的增大，解发散。

![二次差分方程解发散](imgs/二次差分方程解发散.png)

**情形2：判别式$d=a_1^2+4a_2=0$**

此时，a1和a2为两个重根，$a_1=a_2=\frac{a_1}{2}$ ，除了$A_1(\frac{a_1}{2})^t$ 是一个解之外，可以验证$A_2t(\frac{a_1}{2})^t$ 是另一个解。于是得到齐次解
$$
y_t^h = A_1(\frac{a_1}{2})^t +A_2t(\frac{a_1}{2})^t，其中A_1，A_2为任意常数
$$
显然当$a_1 \ge 2$ 时，解就发散；当$a_1 \lt 2$ 时，解就收敛。

**情形3：判别式$d=a_1^2+4a_2 \lt 0$**

此时$a_2 \lt -\frac{a_1^2}{4} \lt 0$ ，a1和a2为两个共轭的虚数特征根，记
$$
a_1=\frac{a_1 + i \sqrt{-d}}{2}，a_2=\frac{a_1 - i \sqrt{-d}}{2}，其中i=\sqrt{-1} \\
令r=(-a_2)^{\frac{1}{2}}，使得满足cos(\theta) = \frac{a_1}{2(-a_2)^{\frac{1}{2}}}，则有 \\
a_1 = r[cos(\theta) + i \ sin(\theta)]，a_2=r[cos(\theta) - i \ sin(\theta)] \\
由De \ Moivre定理可以得到：\\
(a_1)^t = r^t[cos(\theta) + i \ sin(\theta)]，(a_2)^t=r^t[cos(\theta) - i \ sin(\theta)] \\
注意齐次解表达式为：y_t^h=A_1(a_1)^t + A_2(a_2)^t \\
因为y_t^h是实数，a_1,a_2是复数，所以A_1，A_2必为复数，假设 \\
A_1= B_1[cos(B_2) + i \ sin(B_2)]，A_2=B_1[cos(B_2) - i \ sin(B_2)] \\
其中B_1，B_2均为任意实数，可以计算出 \\
A_1(a_1)^t = B_1r^t[cos(t \theta + B_2) + i \ sin(t \theta + B_2)] \\
A_2(a_2)^t = B_1r^t[cos(t \theta + B_2) - i \ sin(t \theta + B_2)] \\
因此可以得到齐次解为：y_t^h = \beta_1r^tcos(t \theta + \beta_2)，其中\beta_1，\beta_2为任意常数
$$
三角函数表达式说明了齐次解在时间路径上像波浪一样，其波动频率取决于$\theta$ 的大小，而解的稳定性则由$r=(-a_2)^{\frac{1}{2}}$ 的值是否小于1或a2是否大于-1所决定。由于$a_2 \lt -\frac{a_1^2}{4} \lt 0$ ，所以

1. 当$r=(-a_2)^{\frac{1}{2}} = 1，即a_2=-1$ ，则波动的增幅不变；
2. 当$r=(-a_2)^{\frac{1}{2}} \lt 1，即-1 \lt a_2 \lt 0$ ，则波动呈递减趋势；
3. 当$r=(-a_2)^{\frac{1}{2}} \gt 1，即a_2 \lt -1 $ ，则波动呈发散趋势；

例子：$y_t =1.6y_{t-1} - 0.9y_{t-2}$ 
$$
其判别式d=a_1^2+4a_2 = 1.6^2-4 * 0.9 = -1.04 \lt 0，\\
令r=(-a_2)^{\frac{1}{2}} = 0.9^{\frac{1}{2}} \approx 0.949 \\
cos(\theta) = \frac{a_1}{2(-a_2)^{\frac{1}{2}}} = \frac{1.6}{2 * 0.949} = 0.843，\theta=0.567 \\
齐次解为：y_t^h = \beta_1(0.949)^t cos(0.577t + \beta_2) \\
取\beta_1=1，\beta_2=0，则随着\theta值增大，波动频率加快。
$$

![二次差分方程判别式小于0时的解](imgs/二次差分方程判别式小于0时的解.png)

注1：实数解可以看成是虚部为0的复数；

注2：常数解或特征根为1的情形可以不在稳定性条件的考虑范围之内，本身他是一个稳定解。

注3：二阶齐次差分方程又可以表示为递推方程$ y_t-a_1y_{t-1} = a_2(y_{t-1} - a_1y_{t-2})$ （有韦达定理得a1+a2和a1a2的值），其中a1，a2为两个特征根，当其中一个特征根a1=1时，则可以表示为$y_t-y_{t-1} = a_2(y_{t-1} - y_{t-2})$ ，此时存在一个常数解。当两个特征根a1=a2=1时，则可以表示为$y_t-y_{t-1} = y_{t-1} - y_{t-2}$ ，此时除了一个常数解，还有一个线性解（类似等差数列）。