##第5章 非平稳时间序列建模

对于不平稳的时间序列有两种分析方法

1. 时间序列确定性分析；
2. 时间序列随机分析，ARMA模型属于时间序列随机分析的一部分。

###5.1 时间序列分解

**Cramer分解定理** ：任何一个时间序列$\{y_t\}$ 都可以分解为两个部分，一部分是由多项式决定的确定性趋势成分，另一部分是平稳的零均值误差成分，即
$$
y_t = \mu_t + \epsilon_t \\
确定趋势\mu_t = \sum_{j=0}^{d} \beta_j t^j \\
随机项 \epsilon_t = \varphi(L)a_t
$$
其中$d < \infty，\beta_1,\beta_2,...,\beta_d$ 为常数系数，$\{a_t\}$ 为一个零均值白噪声序列，L为延迟算子，且满足
$$
E(\epsilon_t) = E(\varphi(L)a_t) = \varphi(L)E(a_t) = 0 \\
E(y_t) = E(\mu_t) = E(\sum_{j=0}^{d} \beta_j t^j) = \sum_{j=0}^{d}\beta_j t^j
$$
**确定性因素分解**

时间序列分析中的因素主要有

1. 长期趋势变动；
2. 循环变动，若循环变动有固定周期则将其归纳到季节性变动中；若循环变动没有固定周期将其归纳到长期趋势中；
3. 季节性变动；
4. 随机波动，除了上述变动的其他所有随机因素构成的变动；

因此在确定性分析中，将序列分解为三大因素

1. 长期趋势（包括长期趋势和无固定周期循环波动）；
2. 季节性变化（包括季节变化和稳定周期的循环波动）；
3. 随机波动；

确定性时间序列分析的目的就是：

1. 克服其他因素影响，单纯测量某个确定性因素对时间序列的影响;
2. 推断确定性因素之间的相互作用，以及其对时间序列的综合影响；

**确定性时间序列分析方法** 

1. 平滑预测法
2. 趋势预测法
3. 分解分析法

###5.2 长期趋势分析与预测

用于长期趋势分析与预测的方法主要由平滑法和趋势拟合法。其中平滑法分为三大类：`移动平滑法`，`加权移动平滑法`，`指数平滑法`。因为每一种方法都是要消除由于时间序列不规则成分所引起的随机波动，所以被称为**平滑法** 。平滑法适用于时间序列在一定的时间内取值比较稳定，序列之间的差异主要是随机波动所引起的，这个时候就可以使用平滑法。

当时间序列可能呈现长期趋势且不能使用平滑法通过均值拟合时，需要采用**趋势拟合法** 找到均值和时间的线性关系，常用的趋势拟合法有：`线性拟合`、`曲线拟合`。

####5.2.1 平滑法

`移动平均法`是一种简单平滑预测技术，其基本思想是根据时间序列资料、逐项推移，依次计算包含一定项数的时序平均值，以反映长期趋势。 

**1. 简单移动平滑SMA** 

计算公式为
$$
\hat{y_{t+1}} = \frac{y_t + y_{t-1} + ... ++ y_{1}}{t}
$$
`代码实现` 



**2. 加权移动平滑WMA** 

针对不同的时间点给予不同的权重，例如最近时间的数据权值大一点，时间距离源远的数据有效性越低。

计算公式为
$$
\hat{y_{t+1}} = \sum_{i=1}^{t} w_i y_i ，其中w_i > 0 \quad \sum w_i = 1
$$
`代码实现` 



**3. 指数加权移动平滑EWMA** 

**K期移动平均法**

只计算前k期的平均值，计算公式为
$$
\hat{y_{t+1}} = \frac{y_{t} +y_{t-1} + ... + y_{t-k+1}}{k}
$$
`代码实现` 



**指数平滑法** 

特殊的加权平滑法，默认是时间越久远影响就越小，`一次指数平滑法`为
$$
F_{t+1} = a Y_t + (1-a)F_t ，其中第一项为真实值，后者为预测值\\
\downarrow \\
y_{t+1} = \sum_{i=0}^{t} a (1-a)^i y_{t-i}
$$
平滑系数a表示真实和预测值占用的权重，其取值分类如下

| 取值范围     | 说明                       |
| ------------ | -------------------------- |
| $[0.1, 0.3)$ | 观测值是一个稳定的水平发展 |
| $[0.3, 0.5)$ | 观测值波动较大             |
| $[0.5, 0.8]$ | 观测值波动较大             |

`代码实现` 

   

####5.2.2 趋势拟合法

简单移动平滑法会把数据当成随机变动，这样数据均值就会显得非常平稳。因此若数据有明显趋势的情况下，用均值进行平滑结果是有问题的。因此采用线性拟合和非线性拟合对均值进行拟合。

**对均值进行线性拟合** 
$$
\mu_t = \beta_0 + \beta_1 t \qquad \qquad \quad\\
\ \\
\hat{\beta_1} = \frac{\sum_{t=1}^{n}(y_t - \overline{y})(t-\overline{t})}{\sum_{t=1}^{n}(t - \overline{t})^2} \\ 
\hat{\beta_0} = \overline{y_t} - \hat{\beta_1} \overline{t} \qquad \qquad \qquad
$$
**对均值进行非线性拟合** 

`二次曲线拟合` 
$$
\mu_t = a + b t + c t^2 \\
\ \\
y_t = a + b t + c t^2 + \epsilon_t \\
E(\epsilon_t) = 0，Var(\epsilon_t) = \sigma^2_{\epsilon} 
$$


`指数曲线拟合` 
$$
\mu_t = ab^t \\
y_t = ab^t + \epsilon_t \\
E(\epsilon_t) = 0，Var(\epsilon_t) = \sigma^2_{\epsilon}
$$

###5.3 季节变动分析与预测

**1. 季节均值法**

季节性或周期性趋势
$$
\mu_t = 
\begin{cases} 
\beta_1 \qquad t=1,13,25,... \\
\beta_2 \qquad t=2,14,26,... \\
... \\
\beta_{12} \qquad t=12,24,26,... \\
\end{cases}
$$




**2. 余弦趋势法**

余弦趋势
$$
\mu_t = \beta cost(2 \pi f t + \phi) \\
根据三角恒等式得到 \\
\beta cost(2 \pi f t + \phi) = \beta_1 cos(2 \pi f t) + \beta_2 sin(2 \pi f t) \\
其中 \beta = \sqrt{\beta_1^2 +\beta_2^2}，\phi = atan(-\frac{\beta_2}{\beta_1}) \\
\beta_1 = \beta cos(\phi)，\beta_2 = \beta sin(\phi)
$$




**3. 季节指数水平法**

单纯考虑季节变动因素，没有考虑长期趋势。季节指数水平法预测模型
$$
y_{ij} = \overline{y} * s_j + \epsilon_{ij}
$$
其中$y_{ij}$ 是第i年的第j个月(或季节)的观测值，$\overline{y}$ 为时间序列的平均水平（可以是上一年或两年或全部数据的平均值），$s_j$ 为第j个月季节指数，$\epsilon_{ij}$为随机波动。 

`算法步骤`

1. 求各年平均数，假设有两年数据，求每年12个月中每个月份的平均值。
2. 求各月对该年平均数比率，每个月中每天的实际值比上该年该月的平均值。
3. 计算季节比率$s_j$ ，$s_j$ 为样本中每年相同月份的比率的平均值，例如：$s_1$ 为两年数据中一月份的比率的平均值。
4. 根据季节指数水平法预测。



**4. 季节指数趋势法**

既考虑季节变动，也考虑长期趋势







