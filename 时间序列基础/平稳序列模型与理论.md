第三章 平稳时间序列模型

### 3.1 随机差分方程模型

y为一个**随机变量** ，是指该变量的取值是随机的，且存在某种规律性，遵守某个概率分布。

- 离散型随机变量，是指y的取值是离散的，其概率分布为
  $$
  P(y=a_i) = p_i，i=1,2,... \quad (p_i \ge 0，p_1+p_2+... = 1)
  $$
  当y以概率1取值为a时，即P(y=a) = 1，则称y为**确定性变量** 

- 连续型随机变量，是指y的取值是连续的，其概率分布为
  $$
  P(y \le x) = F(x) = \int_{-\infty}^{x}f(x)dx ，f(x) \ge 0 ，\int_{+\infty}^{-\infty}f(x)dx=1
  $$






   其中f(x)称为密度函数（概率函数）

- 随机变量可以为多元，其概率分布式（离散或连续）多元函数，称之为**联合概率分布** 

$y_t，\epsilon_t$ 是随机的，一般认为推动项${x_t}$ 是确定的

随机过程的概念

设$y_t$ 为一个随机变量，则

- 当t离散变化时，称$\{y_t\}$ 为**离散参数随机过程** 或**随机序列** ；
- 当t连续变化时，称$\{y_t\}$ 为**连续参数随机过程** 。

若对任意的参数t，$y_t$ 都为离散型随机变量，则称$\{y_t\}$ 为**离散型随机过程** ；若对于任意的参数t，$y_t$ 都为**连续型随机变量** ，则称$\{y_t\}$ 为**连续型随机过程**。对于随机过程$\{y_t\}$ 进行一次观测或实验，就得到$\{y_t\}$ 的一个实现值，称它为关于t的一个**样本函数**（离散或连续）。

例子：设$y_t$ 为第t次轮盘赌的点数，其概率就等于该点数在轮盘中所占面积的比例，则
$$
P(y_t=i) = p_i ，i=1,2,..,n， p_i \ge 0，p_1 + p_2 + ... + p_n = 1
$$
则$\{y_t\}$ 是一个随机过程。

> 预测值就是期望值，我们只能预测其平均值。模型要做的事情就是在有随机项的情况向，人能预测变量的值，将预测值回归到接近其真实值中。因此得到的方程就称为回归方程。

**白噪声过程** 

$\{\epsilon_t\}$ 称为**白噪声过程** ，如果$\{\epsilon_t\}$ 中每个元素`的均值都为0，方差相同，且相互之间没有自相关`，即
$$
E(\epsilon_t) = E(\epsilon_{t-1}) = ... = 0  \\
E(\epsilon_t^2) = E(\epsilon_{t-1}^2) = ... = \sigma^2或 \\
var(\epsilon_t) = var(\epsilon_{t-1}) = ...=\sigma^2 \\
E(\epsilon_t \epsilon_{t-s}) = E(\epsilon_{t-j} \epsilon_{t-j-s})= 0或 \\
cov(\epsilon_t \epsilon_{t-s}) = cov(\epsilon_{t-j} \epsilon_{t-j-s}) = 0，j,s=1,2...
$$
通常用$\{\epsilon_t\}$ 代表白噪声过程，用$\sigma^2$ 代表该过程的方差，若涉及两个或两个以上白噪声过程，则用$\{\epsilon_{1t}\} 或\{\epsilon_{2t}\}$ 等来表示。当$\{\epsilon_t\}$ 是一个正态白噪声过程时，则$\epsilon_t，....$ 相互独立且同服从正太分布$N(0, \sigma^2)$ ，``在正态分布中，不相关和独立是一回事``。

**p阶自回归 AR(p)**

线性差分方程
$$
y_t = a_0 + \sum_{i=1}^{p} a_i y_{t-i} +\epsilon_t
$$
称为p阶自回归模型，记为$AR(p)$

**q阶移动平均 MA(q)** 

考虑用白噪声过程$\{\epsilon_t\}$ 来构造时间序列的推动过程
$$
y_t =  \beta_1 \epsilon_{t-1} + ... + \beta_q \epsilon_{t-q}=  \sum_{i=1}^{q}\beta_i \epsilon_{t-i}
$$
称它为q阶移动平均，记作**MA(q)** ，白噪声的线性组合。

例子：用$\{\epsilon_t\}$ 表示第t次抛硬币的结果，正面为1美元，反面为-1美元，则t时的前4次平均结果为
$$
x_t = \frac{1}{4} \sum_{i=1}^{4}\epsilon_{t-i} =  \sum_{i=1}^{4} \frac{1}{4} \epsilon_{t-i}
$$
当有两个或两个以上的$\beta_t$ 不为零，则$\{x_t\}$ 一般不再是白噪声过程，实际上
$$
E(x_t) = 0，var(x_t) = \sigma^2 \sum_{i=1}^{q} \beta^2 \\
E(x_t x_{t-s}) = cov(x_t, x_{t-s}) = \sigma^2 \sum_{t=s+1}^{q} \beta_i \beta_{i-s} \quad (s \le q)一般不为零
$$
**自回归移动平均ARMA模型** 

将AR(p)和MA(q)合并，得到ARMA(p,q)模型
$$
y_t = a_0 + \sum_{i=1}^{p} a_i y_{t-i} + \sum_{i=0}^{q}\beta_i \epsilon_{t-i}
$$
称它为**p阶自回归和q阶移动平均模型**，这里$\beta_0 = 1$ ，实际MA有$q+1$项，增加了AR中的误差项$\epsilon_t$。在ARMA模型中，p,q允许取无穷大。

当上式中的特征根至少有一个大于等于1时，则称$\{y_i\}$ 为积分过程，此时方程称为**自回归求积移动平均模型（ARIMA），记作ARIMA(p,q)** ，这里的"求积"是指求积分即求和。“求积”过程：当有一个特征值大于1，则解就不稳定，是发散的，因此对其进行一阶差分，再看其是否稳定，若是不稳定再做二阶差分，一般最多3次就能得到稳定结果。

> 统计学要解决的主要问题：区间估计并给出区间的可信度、假设检验。

利用滞后算子，将(9)式变为
$$
(1 - \sum_{i=1}^{p}a_i L^i) y_t = a_0 + \sum_{i=1}^{q} \beta_i \epsilon_{t-i} \\
解为：y_t = \frac{a_0 + \sum_{i=1}^{q} \beta_i \epsilon_{t-i} }{1 - \sum_{i=1}^{p}a_i L^i} \\
当p=1，q=0是，得到AR(1)模型：\\
y_i = \frac{a_0}{1-a_1} + \sum_{i=0}^{\propto} a_1^i \epsilon_{t-i}
$$
注意：解的表达式会生成$MA(\infty)$ 过程，关键是展开是是否收敛，或随机差分方程是否稳定，或时间序列$\{y_t\}$ 是否平稳。该平稳条件等价于多项式$(1-\sum a_i L^i)$ 的根是否在单位圆之内。

> 任何复杂的非线性过程，在局部肯定可以使用线性进行拟合，只要这个局部足够小满足线性条件即可。

###3.2 平稳性（Stationarity）

`若时间序列是平稳的，则根据一个观测得到的实际值集合和由此估计出的均值、方差和自相关值，可以用来预测或充分逼近长期时间平均`。例如：观测了机器1到20个时段的产量，并已知产量是平稳的，则可以用
$$
\hat{y_t} \approx \sum_{i=1}^{20} \frac{y_{it}}{20}
$$
来估计产量的平均值。用这个方法估计时，可假设每一时期的均值相等，方差可能变化。$ 若是\{y_t\}平稳过程=> 可以用均值预测 $

`如何证明平稳性？（特征根的绝对值在单位圆之内）`。若可以证明序列是平稳的！则可以用时间序列模型ARMA进行预测。

对所有t，t-s和j，若随机过程满足
$$
E(y_t) = E(y_{t-s}) = \mu \\
E(t_t - \mu)^2 = E(t_{t-s} - \mu)^2 = \sigma_y^2或var(\epsilon_t) = var(\epsilon_{t-s})=\sigma_y^2 \\
cov(y_t, y_{t-s}) = cov(y_{t-j}, y_{t-j-s}) = \gamma_s \\
其中\mu，\sigma_y^2，所有\gamma均为有限常数
$$
则称上述随机过程为**协方差平稳** （均值和方差为常数）的。其中$cov(y_t,y_{t-s})$ 称为**自协方差** 。协方差平稳过程又称**弱平稳**、**二阶平稳**或**广义平稳** 过程。通常只考虑协方差平稳过程。

由于$\gamma_0 = \sigma_y^2$ ，因此$y_t$ 和$y_{t-s}$ 的**自相关系数** 为
$$
\rho_s = \frac{cov(y_t, y_{t-s})}{\sqrt{var(y_t)} \sqrt{var(y_{t-s})}} = \frac{\gamma_s}{\sigma_y^2} = \frac{\gamma_s}{\gamma_0}
$$
两个不同序列的协方差或相关系数又称之为**互协方差**或**互相关系数** 。

> 白噪声前后不相关，平稳过程前后相关

####3.2.1 AR(p)平稳性条件

考虑带白噪声的一阶差分方程
$$
y_t = a_0 + a_1 y_{t-1} + \epsilon_t
$$
假设该序列从基期（0期）开始，初始条件为$y_0$ ，其解为
$$
y_t = a_0 \sum_{i=0}^{t-1} a_1^i +a_1^t y_0 + \sum_{i=0}^{t-1} a_1^i \epsilon_{t-i}
$$
对上式两边取期望值得
$$
E(y_t) = a_0 \sum_{i=0}^{t-1} a_1^i + a_1^t y_0
$$
递推s个时刻，得打
$$
E(y_{t+s}) = a_0 \sum_{i=0}^{t+s-1} a_1^i + a_1^{t+s} y_0
$$
由于$E(y_t) =E(y_{t+s})$ 一般不成立，所以，该序列不平稳。

然后t很大时，考虑对(15)求极限，若$|a_1|  \lt  1$ ，则有
$$
\lim_{t \to \infty} y_t = \frac{a_0}{1 - a_1} +\lim_{t \to + \infty} \sum_{j=1}^{t} a_1^{t-j} \epsilon_j
$$
对两边取期望值，可知，当t充分大时，有
$$
E(y_t) \approx \frac{a_0}{1-a_1} = \mu
$$
此时，$y_t$ 的均值为有限常数，且独立于时间变化。同样对$y_t$ 求方差，当t很大时（常数项忽略）有
$$
E(y_t - \mu)^2 \approx E(\epsilon_t + a_1 \epsilon_{t-1} + + a_1^2 \epsilon_{t-2} + ...)^2 \\
= \sigma^2(1 + a_1^2 + a_1^4 + ...) = \frac{\sigma^2}{1 - a_1^2}
$$
接着求自协方差，当t很大时，可得
$$
E(y_t - \mu)(y_{t-s} - \mu) \\
\approx E(\epsilon_t + a_1 \epsilon_{t-1} + + a_1^2 \epsilon_{t-2} + ...)(\epsilon_{t-s} + a_1 \epsilon_{t-s-1} + + a_1^2 \epsilon_{t-s-2} + ...) \\
=\sigma^2 a_1^s(1 + a_1^2 + a_1^4+...) = \frac{\sigma^2 a_1^s}{1 - a_1^2}
$$
因此当t很大时，序列$\{y_t\}$ 趋向于平稳。

对于一个线性的白噪声时间序列，AR(1)过程开始时一般不平稳，但经过较长时间后会趋于平稳。

初始条件对长期后趋向于平稳的时间序列一般不起作用，如果没有初始条件，则$\{y_t\}$ 的通解为
$$
y_t = \frac{a_0}{1-a_1} + \sum_{i=0}^{\infty} a_1^i \epsilon_{t-i} + Aa_1^t，其中A为常数
$$
因为
$$
E(y_t) = \frac{a_0}{1 - a_1} + Aa_1^t
$$
所以除非$Aa_1^t =0 $ ，否则$\{y_t\}$ 不平稳。因此**平稳性条件** 必须满足

1. 齐次解中的通解$Aa_1^t = 0$ 或该序列从很久以前开始，或该过程始终趋于平衡（此时A=0）;
2. 特征根a1的绝对值必须小于1，即$|a_1| \lt1$；

这两个条件对于所有的ARMA(p,q)都适用。实际上，ARMA(p,q)的齐次解为
$$
\sum_{i=1}^{p}A_i a_i^t
$$
当有m个重根时，齐次解为
$$
a_t \sum_{i=1}^{m}A_i t^i + \sum_{i=m+1}{p}A_i a_i^t，其中A_i为常数，a为重根，a_i为相异根 
$$
若齐次方程的任意部分是既定的，其均值、方差和所有协方差都独立于时间变化，则对任意的ARMA(p,q)模型，`齐次解为0是平稳性的必要条件`（因为存在t值是会变化的）。

**AR(p)平稳条件(t很大)** 

1. 模型对应的齐次方程的特征方程的特征根在单位圆内；
2. 齐次解为0；

#### 3.2.2  MA(q)平稳条件

MA(q)的模型为
$$
y_t = \sum_{i=0}^{q} \beta_i \epsilon_{t-i} \\
E(y_t) = 0，Var(y_t) = \sigma^2 \sum_{i=s}^{q} \beta_i^2，cov(y_t, y_{t-s}) = \sigma^2 \sum_{i=s}^{q} \beta_i \beta_{i-s}
$$
由于其级数求和为有限级数求和到q，所以MA(q)始终平稳。

####3.2.3 ARMA(p,q)平稳性条件 

先考虑ARMA(2,1)模型，由于截距项不影响平稳性，故设它为0，即$a_0=0$ ，于是模型可以为
$$
y_t = a_1y_{t-1} + a_2 y_{t-2} + \epsilon_t + \beta_1 \epsilon_{t-1}
$$
有上一节可以知，齐次解为0是平稳性的必要条件，因此只需要求特解，用待定系数法，特解为
$$
y_t = \sum_{i=0}^{\infty}a_i \epsilon_{t-i}
$$
带入方程可以求得
$$
a_0 \epsilon_t + a_1 \epsilon_{t-1}+ a_2 \epsilon_{t-2} + ....\\
=a_1( a_0 \epsilon_{t-1} + + a_1 \epsilon_{t-2} + + a_2 \epsilon_{t-3}) + ... + \\
a_2( a_0 \epsilon_{t-2} + a_1 \epsilon_{t-3} + a_2 \epsilon_{t-4} + a_3 \epsilon_{t-5} +...) + \epsilon_t + \beta_1 \epsilon_{t-1}
$$
所以得到
$$
a_0 = 1，a_1=a_1a_0 + \beta_1 = a_1 + \beta_1 \\
a_i = a_1 a_{i-1} +a_2 a_{i-2}，i \ge 2
$$
序列$\{a_i\}$ 收敛的条件是特征根在单位圆之内。

例题：$y_t = 1.6y_{t-1} - 0.9y_{t-2} + \epsilon_t + 0.5\epsilon_{t-1}$

其解为$y_t = \sum_{i=0}^{\infty}a_i \epsilon_{t-i}$ 的系数满足
$$
a_0 = 1，a_1 =  1.6 +0.5 = 2.1\\
a_i = 1.6a_{i-1} - 0.9a_{i-2}
$$
上述差分方程的解为
$$
a_i = 0.949^i \beta_1 cos(0.567i + \beta_2)，i \ge 2
$$
在满足a0=1,a1=2.1的情况下求得$\beta_1和\beta_2$ 的值。因为$\{\epsilon_t\}$ 是白噪声，所以
$$
E(y_t) = 0 ，var(y_t) = \sigma^2 \sum_{i=0}^{\infty} a_i^2 \\
cov(y_t，y_{t-s}) = E(\sum_{i=0}^{\infty}a_i \epsilon_{t-i} \sum_{i=0}{\infty}a_i \epsilon_{t-s-i}) = \sigma^2 \sum_{i=s}^{\infty}a_i a_{i-s}
$$
因此，$cov(y_t, y_{t-s})$ 只与s有关与t无关，即当上面的求和公式收敛时，$\{y_t\}$ 为平稳序列。(30)的`特征根都在单位圆之内是它的充要条件`。

把AR(p)和MA(q)模型合并起来就可以得到ARMA(p,q)模型的平稳性限制条件。实际上只要ARMA模型的解的特征根都在单位圆之内，则$\{y_t\}$ 序列是平稳。

###3.3 自相关函数(Auto Correlation Function，ACF)

**AR(p)的自相关函数**

考虑AR(1)的模型为
$$
y_t = a_0 + a_1 y_{t-1} + \epsilon_t
$$
当t很大时，且平稳条件满足$|a_1| \lt 1$，方差和协方差分别为
$$
\gamma_0 = E(y_t - \mu)^2 = \frac{\sigma_2}{1- a_1^2} \\
\gamma_s = E(y_t - \mu)(y_{t-s} - \mu) = \sigma^2 \frac{a_1^s}{1 - a_1^2}
$$
所以，自相关系数为，**自相关函数**（ACF）或**自相关曲线**  $\rho_s$ 。相关系数越接近于1说明两个变量越接近于线性相关。关于$s$ 的函数。
$$
\rho_0 = 1，\rho_1 = a_1，\rho_2 = a_1^2，...，\rho_s = a_1^s
$$
由于AR(1)满足平稳条件可以得到

1. 当$0 \lt a_1 \lt 1$ ，自相关系数直接收敛到0；
2. 当$-1 \lt a_1 \lt 0$ ，自相关系数震荡收敛到0；

同理在AR(2)，AR(3)，...时，其收敛条件是取决于$a_1，a_2，a_3，...$ ，若$|a_i| \lt 1$ 则`AR(p)的ACF逐步收敛到0(拖尾)`。 

**MA(q)的自相关函数**

考虑MA(1)模型的ACF，模型为
$$
y_t = \epsilon_t + \beta \epsilon_{t-1}
$$
由于$y_t$ 的表达式是由白噪声序列项组成，所以不需要平稳条件，就可以得出其自相关函数形式如下
$$
\rho_0 = 1，\rho=\frac{\beta}{1 + \beta^2}，...，\rho_s = 0（s \gt 1）
$$

因此，`对于MA(q)模型，p+1阶开始都为0，即到了p阶之后突然截断变为0`。

**ARMA(p,q)的自相关函数**


ARMA(p,q)的自相关函数满足差分方程
$$
\rho_i = a_1 \rho_{i-1} + a_2 \rho_{i-2} + ... + a_p \rho_{i-p}
$$

前p个rho值可以看做是*Yule-Walker* 方程的初始条件，其他滞后值取决于特征方程，从p+1开始就满足一个差分方程而这个方程对应的特征根方程和AR(p)对应的一样，因此其自相关q期后开始衰减。


###3.4 偏自相关函数（Partial Auto Correlation Function，PACF）

相关或不相关：在统计学中，两个变量的相关或不相关都是在线性回归的意义下来考虑的；回归系数大于零就称为（线性）相关；等于零就称为（线性）不相关。

偏相关：两个变量的相关或不相关有两种情况：即跟其他变量相关或不相关。一般的相关不考虑跟其他变量的关系，因此两个变量都可能跟其他变量相关。**偏相关** （系数）则是在排除了其他变量的影响后这两个变量的相关（系数）。

**偏自相关系数 （PACF）**：$y_t$ 和$y_{t-s}$ 的偏自相关系数是指它们（或$\{y_t\}$）排除了变量$y_{t-1}，y_{t-2}，...，y_{t-s+1}$ 的影响后两者的相关系数。所以，$y_t$ 和$y_{t-1}$ 的偏自相关系数就等于它们的相关系数。$\{y_{t-s}\}$ 就是t-s之前的影响结果，因此本身就包含的之前的影响。

**AR(p)模型的偏自相关函数**

$y_t$ 和$y_{t-2}$ 虽然也有回归关系
$$
y_t = a_0 + a_0 a_1 + a_1^2 y_{t-2} +\epsilon_{t} + a_1 \epsilon_{t-1}
$$
但这是通过$y_{t-1}$ 产生的，如果排除了$y_{t-1}$ 的影响，则$y_t$ 和$y_{t-2}$ 就不相关了。因此其偏自相关系数就等于0。**对于AR(p)过程，$y_t$ 和$y_{t-s}  \quad (s \gt p)$ 的偏自相关系数都等于0，即对于AR(p)过程，当s>p的时候，$y_t$和$y_{t-s}$的偏自相关系数为0所以AR(p)的PACF图的一个特征就是在p滞后截断。** 

**MA(q)模型的偏自相关函数**

因为MA(1)模型为
$$
y_t = \epsilon_t + \beta \epsilon_{t-1} = (1 + \beta L) \epsilon_t \\
\epsilon_t = \frac{y_t}{1 + \beta L} = y_t - \beta y_{t-1} + \beta^2 y_{t-2} - \beta^3 y_{t-3} + ...
$$
所以，$y_t$ 同其所有滞后都相关或偏相关；

- 当$\beta \lt 0 $ 时，PACF系数直接衰减；
- 当$\beta \gt 0$ 时，PACF系数震荡衰减；

`平稳ARMA(p,q)过程的偏自相关系数将从p期开始趋于0`，衰减模式取决于多项式$1 + \beta_1 L + \beta_2 L^2 + ... + \beta_q L^q$ 的系数。

**ARMA(p,q)模型的偏自相关函数**

ARMA(p,q)模型对应的PACF图在哪一点开始陡然下降取决于p(与AR特点有关)，其趋于0的方式取决于MA部分的系数。即平稳ARMA(p,q)过程的偏自相关系数PACF将从p期开始趋于0，衰减模式取决于多项式的$1 + \beta_1 L + \beta_2 L^2 + ... + \beta_q L^q$ 系数。

**偏自相关系数计算** 

偏自回归系数是先做两个回归，然后再对两个回归得到的残差做回归，最终得到的偏自回归系数，和直接用多个回归元对回归子做回归得到的系数的结果是一样的。

首先，对每一个观测值做标准变换，得到
$$
y^*_t = \frac{y_t - \mu}{\sigma}
$$
接着构造1阶自回归方程
$$
y_t^* = \phi_{11} y_{t-1}^* + e_{1t}
$$
其中$e_i$ 为误差项，$\{e_i\}$ 不一定是白噪声过程。因为在$y_t$ 和$y_{t-1}$ 之间无插入值，所以$\phi_{11}$ 同时为$y_t$ 和$y_{t-1}$ 的自相关系数和偏自相关系数。

再构造2阶自回归方程
$$
y_t^* = \phi_{21} y_{t-1}^* +  \phi_{22} y_{t-2}^*+ e_{2t}
$$
则$\phi_{22}$ 为$y_t$ 与$y_{t-2}$ 之间的偏自相关系数。一般地，可以构造s阶自回归方程
$$
y_t^* = \phi_{s1} y_{t-1}^* +  \phi_{s2} y_{t-2}^*+ ... + \phi_{ss} y_{t-s}^* + e_{st}
$$
则有一下公式
$$
\phi_{11} = \rho_1 \\
\phi_{22} = \frac{\rho_2 - \rho_1^2}{1 - \rho_1^2} \\
... \\
\phi_{ss} = \frac{\rho_s - \sum_{j=1}^{s-1}\phi_{s-1,j} \rho_{s-j}}{1 - \sum_{j=1}^{s-1}\phi_{s-1,j} \rho_{s-j}}
$$




###3.5 平稳序列的样本自相关

$$
k阶原点矩 \quad  E[X^k] = \int_{+\infty}^{-\infty} x^k f(x) dx  \quad k=1,2,3... \\
k阶中心距  \quad E[(X-E(X))^k] = \int_{+\infty}^{-\infty} (x- \mu)^k f(x) dx \\
k+l阶混合中心距 \quad E\{[X - E(X)]^k[Y - E(Y)]^l\}
$$

均值为1阶原点矩，方差为2阶中心距表示数的离散程度。三阶中心距称为偏度表示数据分布偏向，四阶中心距称为峰度，峰度越大两边拖尾越长，出现异常数据的概率就越大。超额峰度等于峰度-3，若大于零则出现异常数据的概率比正态分布大，若小于0则出现异常数据的概率分布比正态分布小。协方差cov(X,Y)是X和Y的二阶混合中心距。

**严平稳性** ：变量的所有阶数的原点矩、中心距、混合中心距均为常数。

**弱平稳性** 

1. 均值$E(y_t)=\mu$ 与时间t无关的常数；
2. 方差$Var(y_t)=\sigma^2$ 与时间t无关的常数；
3. 协方差$Cov(y_t, y_{t+s}) = \gamma_{0,s}$ 只与时间间隔s有关，与时间t无关的常数。

样本特性：对于一个时间序列，通常其真实的均值、方差、自相关函数和偏自相关函数式未知的，在序列平稳的条件下，可以用样本的均值、方差、自相关系数和偏自相关系数分别进行估计。假定有T的观测值$y_1,y_2,...y_t$ ，则它们的定义为
$$
样本均值 \quad \overline{y} = \frac{1}{T} \sum_{i=1}^{T} y_i \\
样本方差 \quad \hat{\sigma^2} \ \frac{1}{T} \sum_{i=1}^{T}(y_i - \overline{y})^2\\
样本自相关系数 \quad \gamma_s = \frac{\sum_{i=s+1}^{T}(y_i - \overline{y})(y_{i-s} - \overline{y})}{\sum_{i=1}^{T}(y_i - \overline{y})^2}，s=1,2,... \\
$$
AR(1)模型估计： $y_t = 0.7y_{t-1} +\epsilon_t$

取y0=0，用电脑程序产生100个均值为0方差为1的正太随机数，让它们作为$\epsilon_1，....，\epsilon_{100}$ 的一组样本值。于是可以计算出$y_1，...，y_{100}$ 自相关系数和偏自相关系数。将样本的图形与理论图形进行比较。样本ACF呈衰减模式，样本的PACF在`滞后一期`有较大峰值和之后都较小，都说明该过程为一个AR(1)模型。



**检验与识别** 

**自由度**(degree of freedom, df)指的是计算某一统计量时，取值不受限制的变量个数。通常df=n-k。其中n为样本数量，k为被限制的[条件数](https://baike.baidu.com/item/%E6%9D%A1%E4%BB%B6%E6%95%B0)或变量个数，或计算某一统计量时用到其它独立统计量的个数。自由度通常用于[抽样分布](https://baike.baidu.com/item/%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83)中。

对于任意分布的标准变换为
$$
x' = \frac{x - \mu}{\sigma} \sim (0, 1)
$$
经过变换的分布服从均值为0，方差为1的分布。经过标准变换后的变量就可以进行比较，将变量无量纲化了。因为不同变量可能有不同的单位，是没有办法比较的。`正态分布进行线性变换后仍然是正态分布`。

`中心极限定理`：对于任意分布X，若其平均值为$\mu$ ，方差为$\sigma^2$ （方差均值存在），在大样本情况下，样本均值 $E(x)= \overline{x}$ ，样本方差$S^2 = \frac{\sigma^2}{n}$  ，则有
$$
\frac{x - \overline{x}}{\sqrt{n}^{-1} \sigma} \sim N(0, 1)
$$
即设从均值为μ、方差为$σ^2$（有限）的任意一个总体中抽取样本量为n的样本，当n充分大时，样本均值的抽样分布近似服从均值为μ、方差为$\frac{σ^2}{n}$的正态分布。

若方差$\sigma$ 未知的情况下用样本方差代替，用样本平均值和样本标准差代替整体的平均值和标准差就得到了`T分布`。

将样本的自相关函数和偏自相关函数与理论上的自相关函数和偏自相关函数进行比较，估计时间序列的真实值。

**假设检验** ，原理是在一个已知的假设下，如果一个特定事件发生的概率格外小，那么我们认为这个假设可能不对。

| terms                  | terms                           | terms                      |
| ---------------------- | ------------------------------- | -------------------------- |
| 零假设 Null Hypothesis | 备择假设 Alternative Hypothesis | 检验统计量 Test Statisttic |
| 拒绝域 Critical Region | 临界值 Critical Value           | p-值 P-Value               |

==区间估计：给你[上界，下界]，误差，以及这个区间的置信度。==

1. Box-Jenkins定理及检验

   讨论了在{y(t)}平稳，且误差为正态分布的假设下，样本自相关系数$\gamma_s$的分布。设时间序列平稳，其误差服从正太分布，则

   - 若序列为MA(s-1)过程，此时样本自相关函数$\gamma_s$ 的期望值为0，s阶之后衰减为0。
     $$
     var(\gamma_s) = T^{-1} ，当s=1时 \\
     var(\gamma_s) = (1 + 2 \sum_{j=1}^{s-1}r^2_j) T^{-1}，当s \gt 1时
     $$

   - 若序列为AR(p)过程，此时偏自相关系数$\phi_{p+i,p+i} = 0$ ，则
     $$
     var(\phi_{p+i,p+i}) \approx T^{-1}
     $$
     且在大样本（T充分大）下，$\gamma_s$ 和$\overline{\phi}_{p+i,p+i}$ 都将趋向于服从均值为0 的正太分布。

2. Box-Pierce的Q统计量

   $H_0$ ：所有样本自相关函数$\gamma_1, ... , \gamma_s$ 的真实值或期望值都为0。

   在$H_0$ 成立的条件下，则Box-Pierce的Q统计量为
   $$
   Q = T \sum_{k=1}^{s}\gamma_k^2 \sim \chi^2(s)
   $$
   因此，当$Q > \chi^2_{s, 1-a}$ 时（小概率事件发生了），就拒绝（否定）原假设$H_0$ 

3. Ljung-Box的修正Q统计量
   $$
   Q  = \frac{T(T+2) \sum_{k=1}^{s}\gamma_k^2}{(T-k)} \sim \chi^2(s)
   $$
   由于样本量或自由度的关系，p和q或s的最大值通常取$\frac{T}{4}$ 。实际上样本量T是有限的，若有一个序列有100个数，在计算样本自相关函数时，间隔1个或者2个，若是间隔太远会导致后面的序列越来越少，例如间隔为50，这样很多数据没有被使用，会导致失真。序列少，样本量越小误差就会越大，所以间隔不超过$\frac{T}{4} 或25\%$

   Box-Jenkins检验的功效比不上Box-Pierce，而它们有比不上Ljung-Box检验（检验出假的能力较强），尤其是在大样本的情形。

4. Q统计量或检验的应用

   Q检验还可以用来检验被估计的$ARMA(p,q)$模型的残差是否为白噪声过程，即求该残差序列的样本自相关系数，并计算其对应的Q统计量，当该Q值很大时，则说明$ARMA(p,q)$模型的残差之间存在相关性，即ARMA(p,q)模型存在失拟；否则可认为不存在。

   `什么是残差？`假设建立模型是$ARMA(p,q)$，而实际的模型是$ARMA(p+1,q+1)$，则会有一项自回归和误差没有被包括，这些未被包括的部分就会存在于误差中。此时的误差称为残差，因为其除了包含真实误差外，还包括模型的残余部分的值在里面。

   由于ARMA(p,q)模型中有p+q个系数，因此残差序列的Q统计量的自由度会随被估计系数的增加而减少，即它服从$Q \sim \chi^2(s-p-q)$ 。若残差序列的模型含有一个常数，则应修改为$Q \sim \chi^2(s - p -q -1)$

例子：使用Box-Jenkins定理检验AR(p)、MA(q)模型中p，q值

$H_{01}$ : 样本自相关函数$\gamma_1$ 的真实值或期望值为0。

根据中心极限定理，进行标准化，得到其检验统计量为
$$
Z_1 = r_1 T^{\frac{1}{2}} \sim N(0,1)
$$
因此，在大样本和5%的风险下， 当$|Z_1| > 2 或 r_1 > 2 T^{-\frac{1}{2}}$ 时，就拒绝原假设$H_{01}$ 。接着，继续进一步检验

$H_{02}$ : 样本自相关函数$r_2$的真实值或期望值为0。

其检验统计量为
$$
Z_2 = r_2(1 + 2r_1^2)^{-\frac{1}{2}} T^{-\frac{1}{2}} \sim N(0,1)
$$
当$|Z_2| > 2 或r_2 > 2(1+2r_1^2)^{\frac{1}{2}} T^{\frac{1}{2}}$ 时，就拒绝原假设$H_{02}$ 。此时，再进一步检验假设$H_{03}, ...$ ；直到检验出MA(q)中的q值。对于AR(p)模型可以采用同样的方式求出p值。 

$H_{01}$ ：样本自相关函数$r_1$ 的真实值或期望值为0，即序列为MA(0)或白噪声。

其检验统计量为
$$
Z_1 = r_1 T^{\frac{1}{2}} = 0.74 * 100^{\frac{1}{2}} = 7.4 > 2
$$
因此，在大样本假设和5%风险下，拒绝原假设$H_{01}$  

$H_{02}$ : 样本自相关函数$r_2$ 的真实值或期望值为0，即序列为MA(1)过程。

则其检验统计量为
$$
Z_2 = r_2(1+2r^2_1)^{-\frac{1}{2}} T^{\frac{1}{2}} = 0.58 * (1 + 2 * 0.74^2)^{\frac{1}{2}} * 100^{\frac{1}{2}} = 4.007 > 2
$$
因此，拒绝原假设$H_{02}$

继续检验$H_03$ ...，直到检验$q=\frac{100}{4}=25$ 为止。结果，它们都不显著，因此取q=2。

**检验单个ACF** 

若时间序列$\{y_t\}$ 是弱平稳时间序列，满足$y_t= \mu + \sum_{i=0}^{q} \psi_i a_{t-i}$ 其中$\psi_0=1$ ，而$\{a_j\}$ 为均值为0的独立同分布随机变量，则对于$k \gt q$ ,相关系数$\hat{\rho_k}$ 渐进服从$N(0, (\frac{1 +2 \sum_{i=1}^{q} \rho_i^2}{T}))$ 

| 原假设               | 备选假设               |
| -------------------- | ---------------------- |
| $H_0$ ：$\rho_0 = 0$ | $H_a$ ：$\rho_k \ne 0$ |

检验统计量
$$
t = \frac{\hat{\rho_k}}{\sqrt{\frac{1 + 2 \sum_{i=1}^{k-1} \hat{\rho}_i^2}{T}}} \sim N(0, 1)
$$
**混成检验** 

| 原假设                                    | 备选假设                                       |
| ----------------------------------------- | ---------------------------------------------- |
| $H_0$ ：$\rho_0 = \rho_1 = ... \rho_m= 0$ | $H_a$ ：$\rho_i \ne 0 \ i \in \{1,2,3,...,m\}$ |

检验多个自相关系数是否同时0，检验统计量
$$
Q(m) = T(T + 2) \sum_{i=1}^{m} \frac{\hat{\rho_i}^2}{T - i}
$$
例如：考虑IBM股票从1967年1月到2009年12月的月简单收益率和对数收益率，样本容量为516，通过查看简单月收益率和对数收益率的样本自相关函数，它们都在2倍的标准误差范围内，表明IBM股票月收益率序列即使存在某种相关性，该自相关性也很小。为了验证该收益率序列没有序列自相关性，我们检验

| 原假设                                    | 备选假设                                       |
| ----------------------------------------- | ---------------------------------------------- |
| $H_0$ ：$\rho_0 = \rho_1 = ... \rho_m= 0$ | $H_a$ ：$\rho_i \ne 0 \ i \in \{1,2,3,...,m\}$ |

其中m为12和24，对于简单收益率，我们有

| Q(12)=7.57  | P-Value=0.82 |
| ----------- | ------------ |
| Q(24)=25.49 | P-值=0.38    |

对于对数收益率有

| Q(12)=7.40  | P-Value=0.83 |
| ----------- | ------------ |
| Q(24)=25.49 | P-值=0.38    |

因此Ljung-Box统计量不能拒绝IBM股票收益率没有显著的前后相关性这一假设。	





###3.6 模型筛选准则

模型的好坏一般考虑两个方面：1. 模型拟合的好坏；2. 预测的好坏。一般使用最小二乘计算计算残差平方和，值越小结果越好。此外，最常用的筛选准则是AIC(Akaike Information Criterion)准则和SBC(Schwartz Bayesian Criterion)准则，它们的计算公式为
$$
AIC = T \ ln(残差平方和) + 2n \\
SBC = T ln(残差平方和) + n ln(T)
$$
其中n为待估参数个数（即p+q+可能的常数项个数），T为可用的观测值个数。要求AIC和SBC尽可能小。这两者皆有可能为负，当拟合优度上升（即残差平方和趋向于0）时，则会趋向于负无穷。

通常AIC准则具有更好的小样本特性；SBC具有更好的大样本特性。SBC准则倾向于选出更简练的模型。理想情形是两者选出相同的模型，否则应谨慎从事。



**总结** 

ARMA(p,q)模型表示为
$$
z_t = \varphi_1 z_{t-1} + \varphi_2 z_{t-2} + ... + \varphi_p z_{t-p} + a_t - \theta_1 a_{t-1} - ... - \theta_q a_{t-q} 
$$
模型简化形式为
$$
\varphi_p(B)z_t = \theta_q(B) a_t \\
\varphi_p(B) = 1 - \varphi_1 B - \varphi_2 B^2 - ... - - \varphi_p B^p \\
\theta_q (B) = 1 - \theta_1 B - \theta_2 B^2 - ... - \theta_q B^q 
$$


|              | $AR(p)$                           | $MA(q)$                      | $ARMA(p,q)$                     |
| ------------ | --------------------------------- | ---------------------------- | ------------------------------- |
| 模型方程     | $\varphi(B) = a_t$                | $z_t=\theta(B)a_t$           | $\varphi(B)z_t = \theta(B) a_t$ |
| 平稳条件     | 模型$\varphi(B) =0$的根在单位圆外 | 无                           | 模型$\varphi(B) =0$的根在单位外 |
| 可逆条件     | 无                                | $\theta(B)=0$ 的根在单位圆外 | $\theta(B)=0$ 的根在单位圆外    |
| 自相关系数   | 拖尾                              | Q步截尾                      | 拖尾                            |
| 偏自相关系数 | P步截尾                           | 拖尾                         | 拖尾                            |

==因此如何确定p和q的阶数呢？从自相关图和偏自相关图中得到，对于p的值，要从偏自相关系图中看从哪一阶后开始衰减；对于q的值，从自相关图中看哪一阶后开始衰减。== 自相关系数与偏自相关系数是用来确定p和q的值，是确定p和q的必要条件。

衰减：从此开始趋近于0，不相关了。







